// Prisma Schema für Prophezeiung App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String   @id @default(cuid())
  username            String   @unique
  passwordHash        String?
  forcePasswordChange Boolean  @default(false)
  displayName         String?
  avatarUrl           String?
  avatarEffect        String?  // 'glow' | 'particles' | 'lightning' | 'none'
  avatarEffectColors  String?  // JSON-Array: ["cyan", "violet", "teal"]
  animationsEnabled   Boolean  @default(true)       // User preference to enable/disable animations
  role                String   @default("USER")     // UserRole: USER, ADMIN
  status              String   @default("PENDING")  // UserStatus: PENDING, APPROVED, REJECTED, SUSPENDED
  isBot               Boolean  @default(false)      // Künstliche Teilnehmer (Randolf, Kimberly)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  authenticators Authenticator[]
  prophecies     Prophecy[]
  ratings        Rating[]
  auditLogs      AuditLog[]
  badges         UserBadge[]
}

model Authenticator {
  id                   String   @id @default(cuid())
  credentialID         String   @unique
  userId               String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String?
  credentialBackedUp   Boolean  @default(false)
  transports           String?
  name                 String   @default("Mein Passkey")
  createdAt            DateTime @default(now())
  lastUsedAt           DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Round {
  id                  String    @id @default(cuid())
  title               String
  submissionDeadline  DateTime
  ratingDeadline      DateTime
  fulfillmentDate     DateTime
  resultsPublishedAt  DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  prophecies          Prophecy[]
}

model Prophecy {
  id          String    @id @default(cuid())
  title       String
  description String
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  roundId     String
  round       Round     @relation(fields: [roundId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  fulfilled   Boolean?
  resolvedAt  DateTime?

  ratings       Rating[]
  auditLogs     AuditLog[]
}

model Rating {
  id          String   @id @default(cuid())
  value       Int
  prophecyId  String
  prophecy    Prophecy @relation(fields: [prophecyId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([prophecyId, userId])
  @@index([prophecyId])
  @@index([userId])
}

model AuditLog {
  id          String   @id @default(cuid())
  entityType  String   // "RATING" | "PROPHECY"
  entityId    String   // ID der betroffenen Entität
  action      String   // "CREATE" | "UPDATE" | "DELETE" | "BULK_DELETE"

  prophecyId  String?
  prophecy    Prophecy? @relation(fields: [prophecyId], references: [id], onDelete: SetNull)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  oldValue    String?  // JSON-String für vorherige Werte
  newValue    String?  // JSON-String für neue Werte
  context     String?  // z.B. "Prophezeiung wurde bearbeitet - alle Bewertungen zurückgesetzt"

  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([prophecyId])
  @@index([userId])
  @@index([createdAt])
}

// Badge System
model Badge {
  id          String        @id @default(cuid())
  key         String        @unique  // z.B. "creator_5", "accuracy_80"
  name        String                 // "Mondleser"
  description String                 // "Die Sterne beginnen zu sprechen"
  requirement String        @default("")  // "5 Prophezeiungen erstellt"
  category    BadgeCategory
  rarity      BadgeRarity
  threshold   Int?                   // Schwellwert für automatische Vergabe

  createdAt   DateTime      @default(now())

  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([earnedAt])
}

enum BadgeCategory {
  CREATOR      // Prophezeiungen erstellen
  ACCURACY     // Trefferquote
  RATER        // Bewertungen abgeben
  RATER_ACC    // Rating-Genauigkeit
  ROUNDS       // Rundenteilnahme
  LEADERBOARD  // Platzierungen
  SPECIAL      // Seltene Ereignisse
  SOCIAL       // Soziale Badges
  HIDDEN       // Easter Eggs
}

enum BadgeRarity {
  BRONZE
  SILVER
  GOLD
  LEGENDARY
}
